# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  pull_request:
    branches: [ master ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
      
      - name: Install Salesforce CLI
        run: |
          npm install sfdx-cli
          node_modules/sfdx-cli/bin/run --version
          node_modules/sfdx-cli/bin/run plugins --core
          - name: 'Populate auth file with SFDX_URL secret'
            shell: bash
          run: 'echo ${{ secrets.SFDX_LR_TEST_URL}} > SFDX_QA'

          - name: 'Authenticate against dev hub'
            run: node_modules/sfdx-cli/bin/run force:auth:sfdxurl:store -f SFDX_QA -s -a LRQA

          - name: Run Apex test
            run: 
              node_modules/sfdx-cli/bin/run force:apex:test:run --resultformat tap --codecoverage -c -r human

          - name: Deploy source
            id: Deploy
            if: github.event_name == 'push'
            run:
              node_modules/sfdx-cli/bin/run force:source:deploy -p diffdeploy/force-app -u LRQA --json --loglevel fatal
